<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙØ§ØªÙˆØ±Ø©</title>
<style>
  body {
    font-family: "Cairo", sans-serif;
    background: #fff;
    margin: 20px;
    color: #000;
  }

  h1 {
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;
    font-size: 28px;
  }

  .info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    font-size: 18px;
  }

  .info label {
    font-weight: bold;
    margin-left: 5px;
  }

  .info .info-detailes {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  /* ØªÙƒØ¨ÙŠØ± Ø®Ø· Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø´ØºÙ„Ø§Ù†Ø© */
  #client, #jobType {
    font-size: 22px;
    font-weight: bold;
  }

  .info input {
    border: none;
    border-bottom: 1px solid #000;
    outline: none;
    text-align: center;
    width: 180px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    font-size: 18px;
  }

  th, td {
    border: 1px solid #000;
    padding: 8px;
    text-align: center;
  }

  th {
    background: #f5f5f5;
    font-weight: bold;
  }

  td input {
    width: 100%;
    border: none;
    outline: none;
    text-align: center;
    font-size: 18px;
  }

  .delete-btn {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  .delete-btn:hover {
    background: #d93636;
  }

  .bottom {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-size: 18px;
  }

  .bottom label {
    font-weight: bold;
    margin: 5px 0;
  }

  .bottom input {
    width: 120px;
    text-align: center;
    border: 1px solid #000;
    border-radius: 6px;
    padding: 5px;
    font-size: 16px;
  }

  .btns {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
  }

  .add-row { background: #4CAF50; color: white; }
  .print { background: #2196F3; color: white; }
  .export { background: #FF9800; color: white; }
  .import { background: #9C27B0; color: white; padding: 5px 20px ;border-radius: 6px; cursor: pointer; }

  input[type="file"] {
    display: none;
  }

  @media print {
    @page { size: A4; margin: 20mm; }
    body { margin: 0; background: white; color: #000; }
    .btns, .delete-btn {
      display: none !important;
    }
    
    /* Ù†Ø®ÙÙŠ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù‡Ø°Ø§ Ø³ÙŠØ¨Ù‚Ù‰ Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯ (Ù„Ø£Ù†Ù†Ø§ ÙˆØ¶Ø¹Ù†Ø§ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù) */
    th:last-child, td:last-child {
      display: none !important;
    }
    input { border: none !important; }
    th { background: #eaeaea !important; }
    h1 { margin-top: 0; }
    table, th, td { border: 1px solid #000; }
  }

  /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø¨Ù†Ø¯ */
  .item-total {
    font-weight: bold;
    font-size: 16px;
    display: inline-block;
    min-width: 60px;
  }
</style>
</head>
<body>

<h1 class="no-print">ÙØ§ØªÙˆØ±Ø©</h1>

<div class="info">
  <div class="info-detailes">
    <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
    <input type="text" id="client" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
  </div>
  <div class="info-detailes">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø´ØºÙ„Ø§Ù†Ø©:</label>
    <input type="text" id="jobType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø´ØºÙ„Ø§Ù†Ø©">
  </div>
  <div class="info-detailes">
    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
    <input type="date" id="date">
  </div>
</div>

<div class="btns">
  <button class="add-row" onclick="addRow()">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
  <button class="print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  <button class="export" onclick="exportCSV()">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
  <label class="import btn btn-secondary">
    ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
    <input type="file" id="importFile" accept=".csv" onchange="importCSV(event)">
  </label>
</div>

<table id="invoiceTable">
  <thead>
    <tr>
      <th style="width: 10%;">Ø§Ù„Ø¹Ø¯Ø¯</th>
      <th style="width: 50%;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
      <th style="width: 12%;">Ø§Ù„Ø³Ø¹Ø±</th>
      <th style="width: 13%;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</th>
      <th style="width: 15%;">Ø­Ø°Ù</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="bottom">
  <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <input type="number" id="total" readonly></label>
  <label>Ø§Ù„ÙˆØ§ØµÙ„: <input type="number" id="paid" oninput="calcRemaining()"></label>
  <label>Ø§Ù„Ø¨Ø§Ù‚ÙŠ: <input type="number" id="remaining" readonly></label>
</div>

<script>
function addRow(focusFirst = true) {
  const table = document.getElementById("invoiceTable").getElementsByTagName('tbody')[0];
  const row = table.insertRow();
  
  const countCell = row.insertCell(0);
  const descCell = row.insertCell(1);
  const priceCell = row.insertCell(2);
  const totalCell = row.insertCell(3); // Ø¬Ø¯ÙŠØ¯: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø¨Ù†Ø¯
  const deleteCell = row.insertCell(4);

  countCell.innerHTML = '<input type="number" min="1" value="1" oninput="calcTotal()">';
  descCell.innerHTML = '<input type="text">';
  priceCell.innerHTML = '<input type="number" min="0" value="0" oninput="calcTotal()">';
  totalCell.innerHTML = '<span class="item-total">0.00</span>';
  deleteCell.innerHTML = '<button class="delete-btn" onclick="deleteRow(this)">Ø­Ø°Ù</button>';

  const countInput = countCell.querySelector("input");
  const descInput = descCell.querySelector("input");
  const priceInput = priceCell.querySelector("input");

  countInput.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); descInput.focus(); }
  });
  descInput.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); priceInput.focus(); }
  });
  priceInput.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); addRow(); }
  });

  if (focusFirst) countInput.focus();
  calcTotal(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙÙˆØ± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ
}

function deleteRow(btn) {
  btn.parentElement.parentElement.remove();
  calcTotal();
}

function calcTotal() {
  const rows = document.querySelectorAll("#invoiceTable tbody tr");
  let total = 0;
  rows.forEach(row => {
    const count = parseFloat(row.cells[0].querySelector("input").value) || 0;
    const price = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const itemTotal = count * price;
    const itemTotalSpan = row.cells[3].querySelector(".item-total");
    if (itemTotalSpan) itemTotalSpan.textContent = itemTotal.toFixed(2);
    total += itemTotal;
  });
  document.getElementById("total").value = total.toFixed(2);
  calcRemaining();
}

function calcRemaining() {
  const total = parseFloat(document.getElementById("total").value) || 0;
  const paid = parseFloat(document.getElementById("paid").value) || 0;
  document.getElementById("remaining").value = (total - paid).toFixed(2);
}

window.onload = () => addRow();

/* ========== ØªØµØ¯ÙŠØ± CSV Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ + Ø§Ù„Ø´ØºÙ„Ø§Ù†Ø© ========== */
async function exportCSV() {
  const client = document.getElementById("client").value || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
  const jobType = document.getElementById("jobType").value || "Ø¨Ø¯ÙˆÙ† Ù†ÙˆØ¹";
  const date = document.getElementById("date").value || "";
  const total = document.getElementById("total").value || "";
  const paid = document.getElementById("paid").value || "";
  const remaining = document.getElementById("remaining").value || "";

  const rows = document.querySelectorAll("#invoiceTable tbody tr");
  let csv = `Ø§Ù„Ø¹Ù…ÙŠÙ„,${client}\nÙ†ÙˆØ¹ Ø§Ù„Ø´ØºÙ„Ø§Ù†Ø©,${jobType}\nØ§Ù„ØªØ§Ø±ÙŠØ®,${date}\n\nØ§Ù„Ø¹Ø¯Ø¯,Ø§Ù„Ø¨ÙŠØ§Ù†,Ø§Ù„Ø³Ø¹Ø±,Ø§Ø¬Ù…Ø§Ù„ÙŠ\n`;

  rows.forEach(row => {
    const count = row.cells[0].querySelector("input").value || "";
    const desc = row.cells[1].querySelector("input").value || "";
    const price = row.cells[2].querySelector("input").value || "";
    const itemTotal = row.cells[3].querySelector(".item-total")?.textContent || "";
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ù„Ùˆ ÙÙŠÙ‡Ø§ (Ù‡Ù†Ø§ Ø¨Ø³ÙŠØ·)
    const safeDesc = String(desc).replace(/,/g, "Ø›");
    csv += `${count},${safeDesc},${price},${itemTotal}\n`;
  });

  csv += `\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹,${total}\nØ§Ù„ÙˆØ§ØµÙ„,${paid}\nØ§Ù„Ø¨Ø§Ù‚ÙŠ,${remaining}\n`;

  try {
    const cleanClient = client.replace(/[\\/:*?"<>|]/g, "");
    const cleanJob = jobType.replace(/[\\/:*?"<>|]/g, "");
    const suggestedName = `ÙØ§ØªÙˆØ±Ø© - ${cleanClient} - ${cleanJob}.csv`;

    const options = {
      suggestedName: suggestedName,
      types: [{ description: "CSV File", accept: { "text/csv": [".csv"] } }],
    };

    const handle = await window.showSaveFilePicker(options);
    const writable = await handle.createWritable();
    await writable.write(csv);
    await writable.close();
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!");
  } catch (err) {
    console.log("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£:", err);
  }
}

/* ========== Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV ========== */
function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split("\n").map(l => l.replace(/\r/g, ""));

    const tableBody = document.querySelector("#invoiceTable tbody");
    tableBody.innerHTML = "";

    document.getElementById("client").value = lines[0]?.split(",")[1]?.trim() || "";
    document.getElementById("jobType").value = lines[1]?.split(",")[1]?.trim() || "";
    document.getElementById("date").value = lines[2]?.split(",")[1]?.trim() || "";

    const startIndex = lines.findIndex(l => l.startsWith("Ø§Ù„Ø¹Ø¯Ø¯"));
    const endIndex = lines.findIndex(l => l.startsWith("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹"));
    const dataLines = (startIndex >= 0 && endIndex >= 0) ? lines.slice(startIndex + 1, endIndex) : [];

    dataLines.forEach(line => {
      if (!line.trim()) return;
      const parts = line.split(",");
      const count = parts[0] || "";
      const desc = parts[1] || "";
      const price = parts[2] || "";
      // parts[3] Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ† Ù„Ù† Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ Ù„Ù„Ø­Ø³Ø§Ø¨ØŒ Ø³Ù†Ø­Ø³Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø±
      addRow(false);
      const lastRow = tableBody.lastElementChild;
      lastRow.cells[0].querySelector("input").value = count.trim() || "0";
      lastRow.cells[1].querySelector("input").value = desc.trim().replace(/Ø›/g, ",") || "";
      lastRow.cells[2].querySelector("input").value = price.trim() || "0";
    });

    // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    document.getElementById("total").value = lines.find(l => l.startsWith("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹"))?.split(",")[1]?.trim() || "";
    document.getElementById("paid").value = lines.find(l => l.startsWith("Ø§Ù„ÙˆØ§ØµÙ„"))?.split(",")[1]?.trim() || "";
    document.getElementById("remaining").value = lines.find(l => l.startsWith("Ø§Ù„Ø¨Ø§Ù‚ÙŠ"))?.split(",")[1]?.trim() || "";

    calcTotal();
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
