
========================================== step 7 customer_transactions ==================================================

INSERT INTO customer_transactions
(customer_id, transaction_type, amount, description, invoice_id, payment_id, transaction_date, created_by, balance_before, balance_after)
WITH ordered_transactions AS (
    SELECT
        t.customer_id,
        t.transaction_type,
        t.amount,
        t.description,
        t.invoice_id,
        t.payment_id,
        t.transaction_date,
        t.created_by,
        CASE WHEN t.transaction_type = 'invoice' THEN t.amount ELSE -t.amount END AS signed_amount
    FROM (
        -- الفواتير فقط (delivered = no, yes, partial)
        SELECT
            invoices_out.customer_id,
            'invoice' AS transaction_type,
            invoices_out.total_after_discount AS amount,
            CONCAT('فاتورة رقم ', invoices_out.id) AS description,
            invoices_out.id AS invoice_id,
            NULL AS payment_id,
            invoices_out.created_at AS transaction_date,
            COALESCE(invoices_out.created_by, 5) AS created_by
        FROM invoices_out
        WHERE invoices_out.delivered IN ('no', 'yes', 'partial')
          AND invoices_out.total_after_discount > 0

        UNION ALL

        SELECT
            invoices_out.customer_id,
            'payment' AS transaction_type,
            invoice_payments.payment_amount AS amount,
            CONCAT('دفعة على فاتورة رقم ', invoices_out.id) AS description,
            invoices_out.id AS invoice_id,
            invoice_payments.id AS payment_id,
            invoice_payments.payment_date AS transaction_date,
            COALESCE(invoice_payments.created_by, 5) AS created_by
        FROM invoices_out
        JOIN invoice_payments ON invoice_payments.invoice_id = invoices_out.id
        WHERE invoices_out.delivered IN ('no', 'yes', 'partial')
    ) AS t
)
SELECT
    customer_id,
    transaction_type,
    amount,
    description,
    invoice_id,
    payment_id,
    transaction_date,
    created_by,
    COALESCE(
        LAG(cumulative_balance) OVER(PARTITION BY customer_id ORDER BY transaction_date, invoice_id, payment_id),
        0
    ) AS balance_before,
    COALESCE(
        LAG(cumulative_balance) OVER(PARTITION BY customer_id ORDER BY transaction_date, invoice_id, payment_id),
        0
    ) + signed_amount AS balance_after
FROM (
    SELECT *,
        SUM(signed_amount) OVER(PARTITION BY customer_id ORDER BY transaction_date, invoice_id, payment_id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_balance
    FROM ordered_transactions
) AS cum;
